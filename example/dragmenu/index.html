<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Regular.js • dragmenu</title>
    <link rel="stylesheet" href="http://getbootstrap.com/dist/css/bootstrap.min.css">
    <script src="../../dist/regular.js"></script>
    <style>
    .clearfix{
      zoom:1;
    }
    .clearfix:after{
      display:block;
      clear:both;
      visibility:hidden;
      height:0;
      overflow:hidden;
      content:".";
    }
      .m-screen{
        height: 800px;
      }
      .m-screen  .container{
        width: 320px;
        height: 640px;
        margin: 80px auto;
        border: 1px solid #ccc;
        position: relative;
      }
      ul{
        list-style-type: none;
        padding: 0;
        margin:0;
      }
      .m-menu{
        position: absolute;
        bottom:0;
        left: 0;
        right: 0;
      }

      .m-menu li:hover .close{
        display: block;
      }
      
      .m-menu .close{
        display: none;
        position: absolute;
        font-weight: bold;
        cursor: pointer;
        right: 6px;
        top:0px;
        line-height: 32px;
      }
      .m-menu li {
        box-sizing: border-box;
        position: relative;
      }
      li.drag{
      }
      li.drag a {
        color: transparent;
        border: 1px dotted #666;
      }
      .m-menu a{
        display: block;
      }
      .m-menu a{
        box-sizing: border-box;
        border: 1px solid #ccc;
        text-align: center;
      }
      .m-menu-0 > li{
        width: 100%;
      }
      .m-menu-1 > li{
        width: 50%;
      }
      .m-menu-2 > li{
        width: 33.3333333333%;
      }
      .m-menu-3 > li{
        width: 25%;
      }
      .m-menu-4 > li{
        width: 25%;
      }
      .m-menu > li{
        height: 32px;
        line-height: 32px;
        float: left;
        position: relative;
      }
      .m-smenu > ul{
        width: 100%;
        position: absolute;
        bottom: 32px;
        left: 0px;
      }
      .m-smenu > ul li{
          width: 100%;
      }
    </style>
  </head>
  <body>

    <div id="app">
      <div class="m-screen">
        <div id="container" class='container'>
        </div>
      </div>
    </div>

    <!-- Templates -->
    <script id="menu" type="text/regular" name='menu'>
      <ul class='m-menu m-menu-{{menus.length}} clearfix' >
        {{#list menus as menu}}
          <li class='m-smenu menu {{menu.drag? "drag": ""}}'  >
            <a href="#" on-drag={{this.drag($index, menus, $event)}} on-click={{menu.show= !menu.show}}>{{menu.name}}</a><span class='close' on-click={{this.remove(menu, menus)}}>x</span>
            <ul r-hide={{!menu.show || menu.drag}}>
              <li r-hide={{menu.children.length > 7}} >
                <a href='#' on-click={{this.add(menu.children)}}> + </a> 
              </li>
              {{#list menu.children as smenu }}
                <li class={{smenu.drag? "drag": ""}}><a href="#" on-drag={{this.drag($index, menu.children, $event)}}>{{smenu.name}}</a><span class='close' on-click={{this.remove(smenu, menu.children)}}>x</span>
                </li>
              {{/list}}
            </ul>
          </li>
        {{/list}}
        <li r-hide={{menus.length >= 4}} on-click={{this.add()}}><a href='#'> + </a> </li>
      </ul>
    </script>

    <script>
    function getRect(elem){
      var docElem, body, win, clientTop, clientLeft, scrollTop, scrollLeft,
        box = { top: 0, left: 0 },
        doc = elem && elem.ownerDocument,win = window, body = doc.body;

      if ( !doc ) {
        return;
      }

      docElem = doc.documentElement;

      // If we don't have gBCR, just use 0,0 rather than error
      // BlackBerry 5, iOS 3 (original iPhone)
      if ( typeof elem.getBoundingClientRect !== "undefined" ) {
        box = elem.getBoundingClientRect();
      }
      clientTop  = docElem.clientTop  || body.clientTop  || 0;
      clientLeft = docElem.clientLeft || body.clientLeft || 0;
      scrollTop  = win.pageYOffset || docElem.scrollTop;
      scrollLeft = win.pageXOffset || docElem.scrollLeft;
      return {
        top: box.top  + scrollTop  - clientTop,
        left: box.left + scrollLeft - clientLeft
      };
    }

    function getPage(ev){
      var doc = document;
      doc = (!doc.compatMode || doc.compatMode == 'CSS1Compat') ? doc.documentElement : doc.body;
      return {
        x: (ev.pageX != null) ? ev.pageX : ev.clientX + doc.scrollLeft,
        y: (ev.pageX != null) ? ev.pageY : ev.clientY + doc.scrollTop
      }
    }
    // 扩展drag方法
    Regular.events.drag = function(elem, fire){
      var isStart = false;
      var timeoutId = null;
      var pageX,pageY;
      function start(ev){
        isStart = true;
        var win = window;
        var page = getPage(ev);
        pageX = page.x;
        pageY = page.y;

        fire({type: 'dragstart', target: elem, pageX: page.x, pageY: page.y});

        
      }
      function move(ev){
        if(!isStart) return;
        if(ev.preventDefault) ev.preventDefault()
        else ev.returnValue = false;
        var page = getPage(ev);
        fire({type: 'dragmove', target:elem, deltaX: page.x-pageX, deltaY: page.y-pageY});

      }
      function end(ev){
        if(!isStart) return;
        isStart = false;
        fire({type: 'dragend'})

      }
      dom.on(document, 'mousemove', move);
      dom.on(document, 'mouseup', end);
      dom.on(elem, 'mousedown', start);
      return function(){
        dom.off(elem, 'mousedown', start);
        dom.off(document, 'mousemove', move);
        dom.off(document, 'mouseup', end);
      }
    }


    function swap(container, index1, index2){
      var tmp = container[index1];
      container.splice(index1, 1)
      container.splice(index2,0, tmp)
    }

    function clone(obj){
      var res = {};
      for(var i in obj) if(obj.hasOwnProperty(i)){
        res[i] = obj[i];
      }
      return res;
    }


    var dom = Regular.dom;
    var Menu = Regular.extend({
      template: '#menu',
      drag: function(index, container, ev){
        switch(ev.type){
          case 'dragstart':
            var rect = getRect(ev.target);
            this.index = index;
            this.offset = {x: ev.pageX - rect.left, y: ev.pageY - rect.top}
            var item = container[index];
            this.cloned = item;
            this.cloned.drag = true;
            this.index = index;
            break;
          case 'dragmove':
            var delta = this.cloned.children? (ev.deltaX+this.offset.x) / 320 * (container.length>3? container.length: container.length+1) : (ev.deltaY+this.offset.y) / 34 ;
            delta = delta > 0? Math.floor(delta): Math.ceil(delta);
            var indx = container.indexOf(this.cloned);

            var cursor = Math.max( 0, Math.min(this.index + delta, container.length - 1 ));
            if(cursor !== indx){
               swap(container, indx, cursor );;
            }
            break;
          case 'dragend':
            this.cloned.drag = false;
            this.index = '';
            this.cloned = null;
        }

      },
      remove: function(item, list){
        var index= list.indexOf(item)
        if(~index) list.splice(index,1);

      },
      add: function(container){
        if(container){
          container.unshift({name:'smenu' + container.length})
        }else{
          this.data.menus.push({name: 'menu' + this.data.menus.length, children: []})
        }
      }

    });


    var app =new Menu({
      data:{
        menus: [
          {name: 'menu0', children:[]},
          {name: 'menu1', children:[]}
        ]}
      }
     ).inject('#container')
    </script>



    
  </body>
</html>
